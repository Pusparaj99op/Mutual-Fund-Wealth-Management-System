<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI Analysis - FIMFP Federal Indian Mutual Fund Portal">
    <title>AI Analysis | FIMFP - Federal Indian Mutual Fund Portal</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üáÆüá≥</text></svg>">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../css/gov-style.css">

    <style>
        .page-header {
            background: linear-gradient(135deg, var(--gov-navy) 0%, var(--gov-navy-dark) 100%);
            color: var(--white);
            padding: 30px 0;
            margin-bottom: 30px;
        }

        .page-header::after {
            content: '';
            display: block;
            height: 4px;
            background: linear-gradient(to right, var(--saffron), var(--white), var(--green));
            margin-top: 30px;
        }

        .page-title-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-icon {
            width: 48px;
            height: 48px;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }

        .page-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: var(--gray-50);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid var(--gov-navy);
        }

        .metric-card.highlight {
            border-left-color: var(--saffron);
            background: rgba(255, 153, 51, 0.1);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gov-navy);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
        }

        .risk-table {
            width: 100%;
            margin-top: 15px;
        }

        .risk-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.85rem;
        }

        .risk-table td:first-child {
            color: var(--gray-600);
        }

        .confidence-bar {
            background: var(--gray-200);
            border-radius: 4px;
            height: 8px;
            margin-top: 10px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(to right, var(--green), var(--saffron));
            border-radius: 4px;
        }

        .text-success {
            color: #138808;
        }

        .text-error {
            color: #F44336;
        }

        /* Autocomplete Styles */
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: var(--gray-50);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item .fund-name {
            font-weight: 500;
            color: var(--gov-navy);
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .autocomplete-item .fund-info {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .autocomplete-item.selected {
            background: rgba(0, 51, 102, 0.1);
        }

        .selected-fund-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 51, 102, 0.1);
            color: var(--gov-navy);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <!-- Skip Navigation -->
    <a href="#main-content" class="skip-nav">Skip to main content</a>

    <!-- Tricolor Strip Banner -->
    <div class="top-banner"></div>

    <!-- Government Secondary Banner -->
    <div class="gov-secondary-banner">
        <div class="container">
            <div class="gov-links">
                <a href="https://india.gov.in" target="_blank" rel="noopener">india.gov.in</a>
                <span class="separator">|</span>
                <a href="https://sebi.gov.in" target="_blank" rel="noopener">SEBI</a>
                <span class="separator">|</span>
                <a href="https://amfiindia.com" target="_blank" rel="noopener">AMFI</a>
            </div>
            <div class="language-switch">
                <button class="lang-btn active" data-lang="en">English</button>
                <button class="lang-btn" data-lang="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <div class="container">
            <div class="header-left">
                <div class="emblem">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/55/Emblem_of_India.svg"
                        alt="Emblem of India" width="65" height="75">
                </div>
                <div class="header-text">
                    <h1 class="portal-title">FIMFP</h1>
                    <p class="portal-subtitle">Federal Indian Mutual Fund Portal</p>
                    <p class="portal-subtitle-hindi">‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§∏‡§Ç‡§ò‡•Ä‡§Ø ‡§Æ‡•ç‡§Ø‡•Ç‡§ö‡•Å‡§Ö‡§≤ ‡§´‡§Ç‡§° ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</p>
                </div>
            </div>
            <div class="header-right">
                <div class="digital-india">
                    <span class="di-text">An Initiative of</span>
                    <span class="di-logo">Team CoDevian</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Navigation -->
    <nav class="main-nav" role="navigation">
        <div class="container">
            <ul class="nav-list">
                <li><a href="../index.html" class="nav-link">Home</a></li>
                <li><a href="browse-funds.html" class="nav-link">Browse Funds</a></li>
                <li><a href="ai-analysis.html" class="nav-link active">AI Analysis</a></li>
                <li><a href="recommendations.html" class="nav-link">Recommendations</a></li>
                <li><a href="portfolio.html" class="nav-link">Portfolio</a></li>
                <li><a href="compare.html" class="nav-link">Compare</a></li>
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="advanced-ai.html" class="nav-link">Advanced AI</a></li>
            </ul>
            <div class="nav-auth" id="navAuth">
                <a href="../login.html" class="btn btn-nav-login">
                    <img src="https://cdn-icons-png.flaticon.com/512/3064/3064197.png" alt="Login"
                        style="width: 16px; height: 16px;">
                    Login
                </a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="page-title-section">
                <img src="https://cdn-icons-png.flaticon.com/512/2103/2103633.png" alt="AI Analysis" class="page-icon">
                <div>
                    <h1 class="page-title">AI-Powered Analysis</h1>
                    <p class="page-subtitle">Monte Carlo simulation and risk analysis for any mutual fund</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content">
        <div class="container">
            <div class="analysis-grid">
                <!-- Analysis Form -->
                <div class="card">
                    <h3 class="card-title">
                        <img src="https://cdn-icons-png.flaticon.com/512/3208/3208726.png" alt="Parameters"
                            style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                        Analysis Parameters
                    </h3>
                    <form id="analysisForm">
                        <div class="form-group" style="position: relative;">
                            <label for="fundSearch">
                                <img src="https://cdn-icons-png.flaticon.com/512/2920/2920293.png" alt="Fund"
                                    style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px;">
                                Search Mutual Fund
                            </label>
                            <input type="text" id="fundSearch" class="form-input"
                                placeholder="Type fund name to search..." autocomplete="off">
                            <input type="hidden" id="fundId" value="">
                            <div id="fundSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="investment">
                                <img src="https://cdn-icons-png.flaticon.com/512/2489/2489756.png" alt="Investment"
                                    style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px;">
                                Investment Amount (‚Çπ)
                            </label>
                            <input type="number" id="investment" class="form-input" placeholder="100000" value="100000"
                                min="1000">
                        </div>
                        <div class="form-group">
                            <label for="days">
                                <img src="https://cdn-icons-png.flaticon.com/512/2693/2693507.png" alt="Time"
                                    style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px;">
                                Forecast Horizon
                            </label>
                            <select id="days" class="form-select">
                                <option value="30">1 Month (30 days)</option>
                                <option value="90">3 Months (90 days)</option>
                                <option value="180">6 Months (180 days)</option>
                                <option value="252" selected>1 Year (252 trading days)</option>
                                <option value="504">2 Years (504 days)</option>
                                <option value="756">3 Years (756 days)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">
                            <img src="https://cdn-icons-png.flaticon.com/512/2103/2103633.png" alt="Run"
                                style="width: 16px; height: 16px;">
                            Run Monte Carlo Simulation
                        </button>
                    </form>

                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
                        <h4 style="font-size: 0.9rem; color: var(--gov-navy); margin-bottom: 10px;">
                            <img src="https://cdn-icons-png.flaticon.com/512/1680/1680012.png" alt="Info"
                                style="width: 14px; height: 14px; vertical-align: middle; margin-right: 5px;">
                            About This Analysis
                        </h4>
                        <ul style="font-size: 0.8rem; color: var(--gray-600); margin-left: 20px;">
                            <li>10,000 simulation paths using Geometric Brownian Motion</li>
                            <li>Value at Risk (VaR) at 95% and 99% confidence</li>
                            <li>Conditional VaR (Expected Shortfall)</li>
                            <li>Probability of loss estimation</li>
                        </ul>
                    </div>
                </div>

                <!-- Results Section -->
                <div>
                    <div class="card" id="resultsCard">
                        <h3 class="card-title">
                            <img src="https://cdn-icons-png.flaticon.com/512/3281/3281295.png" alt="Results"
                                style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                            Analysis Results
                        </h3>
                        <div id="resultsContent">
                            <div class="empty-state">
                                <img src="https://cdn-icons-png.flaticon.com/512/2920/2920313.png" alt="Chart"
                                    style="width: 64px; height: 64px; opacity: 0.5; margin-bottom: 15px;">
                                <p>Enter parameters and run simulation to view AI prediction results</p>
                            </div>
                        </div>
                    </div>

                    <!-- Historical NAV Chart Section -->
                    <div class="card" id="historyChartCard" style="margin-top: 20px;">
                        <h3 class="card-title">
                            <img src="https://cdn-icons-png.flaticon.com/512/2920/2920313.png" alt="History"
                                style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                            Historical NAV Performance
                        </h3>
                        <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-outline period-btn" data-period="1M">1M</button>
                            <button class="btn btn-sm btn-outline period-btn" data-period="3M">3M</button>
                            <button class="btn btn-sm btn-outline period-btn" data-period="6M">6M</button>
                            <button class="btn btn-sm btn-primary period-btn active" data-period="1Y">1Y</button>
                            <button class="btn btn-sm btn-outline period-btn" data-period="3Y">3Y</button>
                            <button class="btn btn-sm btn-outline period-btn" data-period="5Y">5Y</button>
                            <button class="btn btn-sm btn-outline period-btn" data-period="MAX">MAX</button>
                        </div>
                        <div id="historyChartStats"
                            style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                            <div style="text-align: center;">
                                <div id="historyStartNav"
                                    style="font-size: 1.1rem; font-weight: 600; color: var(--gov-navy);">-</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">Start NAV</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="historyEndNav"
                                    style="font-size: 1.1rem; font-weight: 600; color: var(--gov-navy);">-</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">Current NAV</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="historyChange" style="font-size: 1.1rem; font-weight: 600;">-</div>
                                <div style="font-size: 0.75rem; color: var(--gray-500);">Change</div>
                            </div>
                        </div>
                        <div id="historyChartContainer">
                            <canvas id="historyChart"></canvas>
                        </div>
                        <div id="historyChartEmpty" class="empty-state" style="display: none; padding: 30px;">
                            <img src="https://cdn-icons-png.flaticon.com/512/2920/2920313.png" alt="Chart"
                                style="width: 48px; height: 48px; opacity: 0.5; margin-bottom: 10px;">
                            <p>Select a fund to view historical NAV data</p>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <div class="card" id="chartCard" style="display: none; margin-top: 20px;">
                        <h3 class="card-title">
                            <img src="https://cdn-icons-png.flaticon.com/512/3281/3281306.png" alt="Chart"
                                style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                            Monte Carlo Simulation Paths
                        </h3>
                        <canvas id="simulationChart"></canvas>
                    </div>

                    <!-- TradingView Widgets Section -->
                    <div class="card" id="tradingViewSection" style="margin-top: 20px; display: none;">
                        <h3 class="card-title">
                            <img src="https://cdn-icons-png.flaticon.com/512/2920/2920322.png" alt="Analysis"
                                style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                            AMC Stock Analysis (TradingView)
                        </h3>
                        <p id="amcStockInfo" style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 15px;">
                            Showing analysis for the parent Asset Management Company's stock
                        </p>

                        <!-- Symbol Info Widget -->
                        <div id="tvWidgetSymbolInfo" class="tradingview-widget-box"
                            style="margin-bottom: 20px; opacity: 0; transition: opacity 0.5s ease-in;"></div>

                        <!-- Widgets Grid -->
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                            <!-- Technical Analysis Widget -->
                            <div class="widget-card"
                                style="background: var(--gray-50); padding: 15px; border-radius: 8px; border: 1px solid var(--gray-200);">
                                <h4
                                    style="font-size: 0.9rem; color: var(--gov-navy); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <img src="https://cdn-icons-png.flaticon.com/512/2920/2920313.png" alt=""
                                        style="width: 16px; height: 16px;">
                                    Technical Analysis
                                </h4>
                                <div id="tvWidgetTechnical" class="tradingview-widget-box"
                                    style="opacity: 0; transition: opacity 0.5s ease-in 0.2s;"></div>
                            </div>

                            <!-- Fundamental Data Widget -->
                            <div class="widget-card"
                                style="background: var(--gray-50); padding: 15px; border-radius: 8px; border: 1px solid var(--gray-200);">
                                <h4
                                    style="font-size: 0.9rem; color: var(--gov-navy); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <img src="https://cdn-icons-png.flaticon.com/512/2830/2830284.png" alt=""
                                        style="width: 16px; height: 16px;">
                                    Fundamental Data
                                </h4>
                                <div id="tvWidgetFundamental" class="tradingview-widget-box"
                                    style="opacity: 0; transition: opacity 0.5s ease-in 0.4s;"></div>
                            </div>

                            <!-- Company Profile Widget -->
                            <div class="widget-card"
                                style="background: var(--gray-50); padding: 15px; border-radius: 8px; border: 1px solid var(--gray-200);">
                                <h4
                                    style="font-size: 0.9rem; color: var(--gov-navy); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" alt=""
                                        style="width: 16px; height: 16px;">
                                    Company Profile
                                </h4>
                                <div id="tvWidgetProfile" class="tradingview-widget-box"
                                    style="opacity: 0; transition: opacity 0.5s ease-in 0.6s;"></div>
                            </div>
                        </div>

                        <!-- No Data Message -->
                        <div id="tvNoData"
                            style="display: none; text-align: center; padding: 40px; color: var(--gray-500);">
                            <img src="https://cdn-icons-png.flaticon.com/512/2920/2920322.png" alt="No data"
                                style="width: 48px; height: 48px; opacity: 0.5; margin-bottom: 10px;">
                            <p>TradingView data not available for this AMC</p>
                            <p style="font-size: 0.8rem;">The parent company may not be publicly listed on stock
                                exchanges</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>¬© 2024 FIMFP - Federal Indian Mutual Fund Portal | Government of India</p>
                <p>Designed & Developed under Digital India Programme by Team CoDevian</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/page-common.js"></script>
    <script src="../js/charts.js"></script>
    <script>
        let simulationChart = null;
        let allFunds = [];
        let selectedFundIndex = -1;

        async function pageInit() {
            // Load funds for autocomplete
            await loadFundsForAutocomplete();

            // Set up autocomplete
            setupAutocomplete();

            // Check for URL parameters
            const params = new URLSearchParams(window.location.search);
            const fundId = params.get('fund_id');
            const autorun = params.get('autorun');

            if (fundId) {
                document.getElementById('fundId').value = fundId;
                // Find and set the fund name
                const fund = allFunds.find(f => f.fund_id == fundId);
                if (fund) {
                    document.getElementById('fundSearch').value = fund.scheme_name;
                }
                if (autorun === 'true') {
                    await runAnalysis();
                }
            }

            document.getElementById('analysisForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await runAnalysis();
            });
        }

        async function loadFundsForAutocomplete() {
            try {
                const result = await window.pageCommon.apiGet('/api/funds?limit=1000');
                if (result.success && result.data) {
                    allFunds = result.data;
                }
            } catch (error) {
                console.error('Failed to load funds:', error);
            }
        }

        function setupAutocomplete() {
            const searchInput = document.getElementById('fundSearch');
            const suggestionsDiv = document.getElementById('fundSuggestions');
            let debounceTimer;

            searchInput.addEventListener('input', function () {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = this.value.toLowerCase().trim();

                    if (query.length < 2) {
                        suggestionsDiv.style.display = 'none';
                        return;
                    }

                    const matches = allFunds.filter(fund =>
                        fund.scheme_name.toLowerCase().includes(query) ||
                        fund.amc_name.toLowerCase().includes(query)
                    ).slice(0, 10);

                    if (matches.length > 0) {
                        renderSuggestions(matches);
                        suggestionsDiv.style.display = 'block';
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                }, 200);
            });

            searchInput.addEventListener('keydown', function (e) {
                const items = suggestionsDiv.querySelectorAll('.autocomplete-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedFundIndex = Math.min(selectedFundIndex + 1, items.length - 1);
                    updateSelectedItem(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedFundIndex = Math.max(selectedFundIndex - 1, 0);
                    updateSelectedItem(items);
                } else if (e.key === 'Enter' && selectedFundIndex >= 0) {
                    e.preventDefault();
                    items[selectedFundIndex]?.click();
                } else if (e.key === 'Escape') {
                    suggestionsDiv.style.display = 'none';
                    selectedFundIndex = -1;
                }
            });

            // Close on click outside
            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                    selectedFundIndex = -1;
                }
            });
        }

        function renderSuggestions(funds) {
            const suggestionsDiv = document.getElementById('fundSuggestions');
            selectedFundIndex = -1;

            suggestionsDiv.innerHTML = funds.map((fund, index) => `
                <div class="autocomplete-item" data-fund-id="${fund.fund_id}" data-fund-name="${fund.scheme_name}">
                    <div class="fund-name">${fund.scheme_name}</div>
                    <div class="fund-info">${fund.amc_name} | ${fund.category} | ‚≠ê ${fund.rating || 'N/A'}</div>
                </div>
            `).join('');

            // Add click handlers
            suggestionsDiv.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function () {
                    const fundId = this.dataset.fundId;
                    const fundName = this.dataset.fundName;

                    document.getElementById('fundId').value = fundId;
                    document.getElementById('fundSearch').value = fundName;
                    suggestionsDiv.style.display = 'none';
                    selectedFundIndex = -1;
                });
            });
        }

        function updateSelectedItem(items) {
            items.forEach((item, index) => {
                item.classList.toggle('selected', index === selectedFundIndex);
                if (index === selectedFundIndex) {
                    item.scrollIntoView({ block: 'nearest' });
                }
            });
        }

        async function runAnalysis() {
            const fundId = document.getElementById('fundId').value;
            const investment = document.getElementById('investment').value;
            const days = document.getElementById('days').value;

            if (!fundId) {
                alert('Please select a mutual fund from the suggestions');
                return;
            }

            // Show loading
            document.getElementById('resultsContent').innerHTML = '<div class="loading"></div>';

            const result = await window.pageCommon.apiGet(`/api/predict/${fundId}?investment=${investment}&days=${days}`);

            if (result.success && result.data) {
                renderResults(result.data);
            } else {
                window.pageCommon.showError('resultsContent', result.error || 'Failed to generate prediction');
            }
        }

        function renderResults(data) {
            const stats = data.statistics;
            const risk = data.risk_metrics;
            const ci = data.confidence_intervals;

            const html = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--gov-navy); margin-bottom: 5px;">${data.fund?.scheme_name || 'Fund'}</h4>
                    <p style="color: var(--gray-500); font-size: 0.85rem;">
                        <img src="https://cdn-icons-png.flaticon.com/512/2693/2693507.png" alt="Time" style="width: 12px; height: 12px; vertical-align: middle;">
                        ${data.prediction_days} days forecast |
                        <img src="https://cdn-icons-png.flaticon.com/512/2103/2103633.png" alt="Simulations" style="width: 12px; height: 12px; vertical-align: middle;">
                        ${data.n_simulations?.toLocaleString() || '10,000'} simulations
                    </p>
                </div>

                <div class="results-grid">
                    <div class="metric-card highlight">
                        <div class="metric-value">‚Çπ${stats.mean_nav?.toLocaleString('en-IN')}</div>
                        <div class="metric-label">Expected Value</div>
                    </div>
                    <div class="metric-card highlight">
                        <div class="metric-value" style="color: ${stats.expected_return_pct >= 0 ? '#138808' : '#F44336'}">
                            ${stats.expected_return_pct >= 0 ? '+' : ''}${stats.expected_return_pct}%
                        </div>
                        <div class="metric-label">Expected Return</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">‚Çπ${stats.std_dev?.toLocaleString('en-IN')}</div>
                        <div class="metric-label">Std Deviation</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">‚Çπ${stats.median_nav?.toLocaleString('en-IN')}</div>
                        <div class="metric-label">Median Value</div>
                    </div>
                </div>

                <h4 style="margin: 20px 0 10px; font-size: 0.95rem;">
                    <img src="https://cdn-icons-png.flaticon.com/512/1055/1055663.png" alt="CI" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
                    Confidence Intervals
                </h4>
                <div style="background: var(--gray-50); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <p style="margin-bottom: 8px;"><strong>90% Confidence:</strong> ‚Çπ${ci['90%']?.lower?.toLocaleString('en-IN')} - ‚Çπ${ci['90%']?.upper?.toLocaleString('en-IN')}</p>
                    <div class="confidence-bar"><div class="confidence-fill" style="width: 90%;"></div></div>
                    <p style="margin: 15px 0 8px;"><strong>50% Confidence:</strong> ‚Çπ${ci['50%']?.lower?.toLocaleString('en-IN')} - ‚Çπ${ci['50%']?.upper?.toLocaleString('en-IN')}</p>
                    <div class="confidence-bar"><div class="confidence-fill" style="width: 50%;"></div></div>
                </div>

                <h4 style="margin: 20px 0 10px; font-size: 0.95rem;">
                    <img src="https://cdn-icons-png.flaticon.com/512/3655/3655585.png" alt="Risk" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 5px;">
                    Risk Metrics
                </h4>
                <table class="risk-table">
                    <tr>
                        <td>Value at Risk (95%)</td>
                        <td><span class="badge" style="background: #FF9800; color: #fff;">‚Çπ${risk.var_95?.toLocaleString('en-IN')}</span></td>
                    </tr>
                    <tr>
                        <td>Value at Risk (99%)</td>
                        <td><span class="badge" style="background: #F44336; color: #fff;">‚Çπ${risk.var_99?.toLocaleString('en-IN')}</span></td>
                    </tr>
                    <tr>
                        <td>CVaR (95%)</td>
                        <td>‚Çπ${risk.cvar_95?.toLocaleString('en-IN')}</td>
                    </tr>
                    <tr>
                        <td>Probability of Loss</td>
                        <td style="color: ${risk.probability_of_loss > 30 ? '#F44336' : '#138808'}; font-weight: 600;">${risk.probability_of_loss}%</td>
                    </tr>
                </table>
            `;

            document.getElementById('resultsContent').innerHTML = html;

            // Render chart
            if (data.sample_paths && data.sample_paths.length > 0) {
                document.getElementById('chartCard').style.display = 'block';
                renderSimulationChart(data.sample_paths, data.current_nav, data.prediction_days);
            }
        }

        function renderSimulationChart(samplePaths, currentNav, days) {
            const ctx = document.getElementById('simulationChart').getContext('2d');
            const labels = Array.from({ length: days }, (_, i) => i + 1);

            const colors = ['#003366', '#FF9933', '#138808', '#1e88e5', '#7c3aed', '#ec4899', '#14b8a6', '#f97316', '#ef4444'];

            const datasets = samplePaths.map((path, index) => ({
                label: `Path ${index + 1}`,
                data: path,
                borderColor: colors[index % colors.length],
                backgroundColor: 'transparent',
                borderWidth: 1.5,
                pointRadius: 0,
                tension: 0.1
            }));

            datasets.push({
                label: 'Initial Investment',
                data: Array(days).fill(currentNav),
                borderColor: '#9E9E9E',
                borderDash: [5, 5],
                borderWidth: 2,
                pointRadius: 0
            });

            if (simulationChart) {
                simulationChart.destroy();
            }

            simulationChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Sample Simulation Paths (from 10,000 total)',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Days' },
                            ticks: { maxTicksLimit: 10 }
                        },
                        y: {
                            title: { display: true, text: 'Value (‚Çπ)' },
                            ticks: {
                                callback: value => '‚Çπ' + value.toLocaleString('en-IN', { maximumFractionDigits: 0 })
                            }
                        }
                    }
                }
            });
        }

        // Historical Chart Variables
        let historyChart = null;
        let currentPeriod = '1Y';

        // Load historical NAV data for selected fund
        async function loadHistoricalChart(fundId, period = '1Y') {
            if (!fundId) {
                document.getElementById('historyChartContainer').style.display = 'none';
                document.getElementById('historyChartEmpty').style.display = 'block';
                return;
            }

            currentPeriod = period;

            try {
                const result = await window.pageCommon.apiGet(`/api/fund/${fundId}/history?period=${period}`);

                if (result.success && result.data && result.data.dates && result.data.values) {
                    document.getElementById('historyChartContainer').style.display = 'block';
                    document.getElementById('historyChartEmpty').style.display = 'none';

                    // Update stats
                    document.getElementById('historyStartNav').textContent = '‚Çπ' + result.data.start_nav.toLocaleString('en-IN');
                    document.getElementById('historyEndNav').textContent = '‚Çπ' + result.data.end_nav.toLocaleString('en-IN');

                    const changeEl = document.getElementById('historyChange');
                    const changePct = result.data.change_pct;
                    changeEl.textContent = (changePct >= 0 ? '+' : '') + changePct + '%';
                    changeEl.style.color = changePct >= 0 ? '#138808' : '#F44336';

                    renderHistoryChart(result.data);
                } else {
                    document.getElementById('historyChartContainer').style.display = 'none';
                    document.getElementById('historyChartEmpty').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load historical data:', error);
                document.getElementById('historyChartContainer').style.display = 'none';
                document.getElementById('historyChartEmpty').style.display = 'block';
            }
        }

        function renderHistoryChart(data) {
            const ctx = document.getElementById('historyChart').getContext('2d');

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            const isPositive = data.change_pct >= 0;
            if (isPositive) {
                gradient.addColorStop(0, 'rgba(19, 136, 8, 0.3)');
                gradient.addColorStop(1, 'rgba(19, 136, 8, 0.0)');
            } else {
                gradient.addColorStop(0, 'rgba(244, 67, 54, 0.3)');
                gradient.addColorStop(1, 'rgba(244, 67, 54, 0.0)');
            }

            // Format dates for display
            const labels = data.dates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' });
            });

            if (historyChart) {
                historyChart.destroy();
            }

            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'NAV (‚Çπ)',
                        data: data.values,
                        borderColor: isPositive ? '#138808' : '#F44336',
                        backgroundColor: gradient,
                        fill: true,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        pointHoverBackgroundColor: isPositive ? '#138808' : '#F44336',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 51, 102, 0.9)',
                            titleFont: { size: 12 },
                            bodyFont: { size: 13 },
                            padding: 12,
                            callbacks: {
                                label: function (context) {
                                    return '‚Çπ' + context.parsed.y.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: 8,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: {
                                callback: value => '‚Çπ' + value.toLocaleString('en-IN', { maximumFractionDigits: 0 }),
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // Setup period buttons
        function setupPeriodButtons() {
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    // Update active state
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.classList.remove('active', 'btn-primary');
                        b.classList.add('btn-outline');
                    });
                    this.classList.remove('btn-outline');
                    this.classList.add('active', 'btn-primary');

                    // Load new period
                    const fundId = document.getElementById('fundId').value;
                    const period = this.dataset.period;
                    if (fundId) {
                        loadHistoricalChart(fundId, period);
                    }
                });
            });
        }

        // Override the original fund selection to also load historical chart
        const originalRenderSuggestions = renderSuggestions;
        renderSuggestions = function (funds) {
            const suggestionsDiv = document.getElementById('fundSuggestions');
            selectedFundIndex = -1;

            suggestionsDiv.innerHTML = funds.map((fund, index) => `
                <div class="autocomplete-item" data-fund-id="${fund.fund_id}" data-fund-name="${fund.scheme_name}" data-amc="${fund.amc_name}">
                    <div class="fund-name">${fund.scheme_name}</div>
                    <div class="fund-info">${fund.amc_name} | ${fund.category} | ‚≠ê ${fund.rating || 'N/A'}</div>
                </div>
            `).join('');

            // Add click handlers with historical chart and TradingView widget loading
            suggestionsDiv.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function () {
                    const fundId = this.dataset.fundId;
                    const fundName = this.dataset.fundName;

                    document.getElementById('fundId').value = fundId;
                    document.getElementById('fundSearch').value = fundName;
                    suggestionsDiv.style.display = 'none';
                    selectedFundIndex = -1;

                    // Load historical chart for selected fund
                    loadHistoricalChart(fundId, currentPeriod);

                    // Load TradingView widgets for selected fund
                    loadTradingViewWidgets(fundId);
                });
            });
        };

        // Load TradingView widgets for a fund
        async function loadTradingViewWidgets(fundId) {
            try {
                // Get fund details including AMC stock symbol
                const result = await window.pageCommon.apiGet(`/api/fund/${fundId}`);

                if (result.success && result.data && result.data.amc_stock_symbol) {
                    const symbol = result.data.amc_stock_symbol;
                    const amcName = result.data.amc_name;

                    // Show section and update info
                    document.getElementById('tradingViewSection').style.display = 'block';
                    document.getElementById('tvNoData').style.display = 'none';
                    document.getElementById('amcStockInfo').innerHTML =
                        `Showing analysis for <strong>${amcName}</strong> parent company stock: <code>${symbol}</code>`;

                    // Clear previous widgets
                    document.getElementById('tvWidgetSymbolInfo').innerHTML = '';
                    document.getElementById('tvWidgetTechnical').innerHTML = '';
                    document.getElementById('tvWidgetFundamental').innerHTML = '';
                    document.getElementById('tvWidgetProfile').innerHTML = '';

                    // Create widgets with delay for animation
                    setTimeout(() => createSymbolInfoWidget(symbol), 100);
                    setTimeout(() => createTechnicalAnalysisWidget(symbol), 300);
                    setTimeout(() => createFundamentalWidget(symbol), 500);
                    setTimeout(() => createProfileWidget(symbol), 700);

                } else {
                    // Show no data message
                    document.getElementById('tradingViewSection').style.display = 'block';
                    document.getElementById('tvNoData').style.display = 'block';
                    document.getElementById('tvWidgetSymbolInfo').innerHTML = '';
                    document.getElementById('tvWidgetTechnical').innerHTML = '';
                    document.getElementById('tvWidgetFundamental').innerHTML = '';
                    document.getElementById('tvWidgetProfile').innerHTML = '';
                }
            } catch (error) {
                console.error('Failed to load TradingView widgets:', error);
                document.getElementById('tradingViewSection').style.display = 'none';
            }
        }

        // Helper function to create and append TradingView widget script
        function createTradingViewScript(container, scriptUrl, config) {
            // Clear container
            container.innerHTML = '';

            // Create widget container structure
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container';

            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            widgetContainer.appendChild(widgetDiv);

            container.appendChild(widgetContainer);

            // Create and append script element properly
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = scriptUrl;
            script.async = true;
            script.textContent = JSON.stringify(config);

            widgetContainer.appendChild(script);

            // Fade in animation
            container.style.opacity = '1';
        }

        // Create Symbol Info Widget
        function createSymbolInfoWidget(symbol) {
            const container = document.getElementById('tvWidgetSymbolInfo');
            createTradingViewScript(container,
                'https://s3.tradingview.com/external-embedding/embed-widget-symbol-info.js',
                {
                    "symbol": symbol,
                    "colorTheme": "light",
                    "isTransparent": true,
                    "locale": "en",
                    "width": "100%"
                }
            );
        }

        // Create Technical Analysis Widget
        function createTechnicalAnalysisWidget(symbol) {
            const container = document.getElementById('tvWidgetTechnical');
            createTradingViewScript(container,
                'https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js',
                {
                    "colorTheme": "light",
                    "displayMode": "single",
                    "isTransparent": true,
                    "locale": "en",
                    "interval": "1D",
                    "disableInterval": false,
                    "width": "100%",
                    "height": 450,
                    "symbol": symbol,
                    "showIntervalTabs": true
                }
            );
        }

        // Create Fundamental Data Widget
        function createFundamentalWidget(symbol) {
            const container = document.getElementById('tvWidgetFundamental');
            createTradingViewScript(container,
                'https://s3.tradingview.com/external-embedding/embed-widget-financials.js',
                {
                    "symbol": symbol,
                    "colorTheme": "light",
                    "displayMode": "regular",
                    "isTransparent": true,
                    "locale": "en",
                    "width": "100%",
                    "height": 500
                }
            );
        }

        // Create Company Profile Widget
        function createProfileWidget(symbol) {
            const container = document.getElementById('tvWidgetProfile');
            createTradingViewScript(container,
                'https://s3.tradingview.com/external-embedding/embed-widget-symbol-profile.js',
                {
                    "symbol": symbol,
                    "colorTheme": "light",
                    "isTransparent": true,
                    "locale": "en",
                    "width": "100%",
                    "height": 500
                }
            );
        }

        // Modify pageInit to setup period buttons and load chart if fund_id present
        const originalPageInit = pageInit;
        pageInit = async function () {
            await originalPageInit();
            setupPeriodButtons();

            // If fund is pre-selected, load its historical chart and TradingView widgets
            const fundId = document.getElementById('fundId').value;
            if (fundId) {
                loadHistoricalChart(fundId, currentPeriod);
                loadTradingViewWidgets(fundId);
            }
        };
    </script>
</body>

</html>
